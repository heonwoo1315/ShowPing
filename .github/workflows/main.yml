name: ShowPing CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Build & Push
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/showping .
          docker push ${{ secrets.DOCKER_USERNAME }}/showping

      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml"
          target: "~/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~
            # .env 파일 생성 로직
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" > .env
            echo "SERVER_PORT=${{ secrets.SERVER_PORT }}" >> .env
            echo "RDS_HOSTNAME=${{ secrets.RDS_HOSTNAME }}" >> .env
            echo "RDS_PORT=${{ secrets.RDS_PORT }}" >> .env
            echo "RDS_DB_NAME=${{ secrets.RDS_DB_NAME }}" >> .env
            echo "RDS_USERNAME=${{ secrets.RDS_USERNAME }}" >> .env
            echo "RDS_PASSWORD=${{ secrets.RDS_PASSWORD }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "AES_GCM_KEY_B64=${{ secrets.AES_GCM_KEY_B64 }}" >> .env
            echo "JPA_DDL_AUTO=${{ secrets.JPA_DDL_AUTO }}" >> .env
            echo "SQL_INIT_MODE=${{ secrets.SQL_INIT_MODE }}" >> .env
            echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            echo "MAIL_PASSWORD=\"${{ secrets.MAIL_PASSWORD }}\"" >> .env
            echo "NCP_ACCESS_KEY=${{ secrets.NCP_ACCESS_KEY }}" >> .env
            echo "NCP_SECRET_KEY=${{ secrets.NCP_SECRET_KEY }}" >> .env
            echo "NCP_CLOVA_API_KEY=${{ secrets.NCP_CLOVA_API_KEY }}" >> .env
            echo "NCP_CLOVA_API_URL=${{ secrets.NCP_CLOVA_API_URL }}" >> .env
            echo "PORTONE_API_KEY=${{ secrets.PORTONE_API_KEY }}" >> .env
            echo "PORTONE_SECRET_KEY=${{ secrets.PORTONE_SECRET_KEY }}" >> .env
            echo "PORTONE_STORE_ID=${{ secrets.PORTONE_STORE_ID }}" >> .env
            echo "PORTONE_CHANNEL_KEY=${{ secrets.PORTONE_CHANNEL_KEY }}" >> .env
            echo "MONGO_HOST=mongo" >> .env
            echo "MONGO_PORT=27017" >> .env
            echo "MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }}" >> .env
            echo "REDIS_HOST=redis" >> .env
            echo "REDIS_PORT=6379" >> .env
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env
            echo "KAFKA_BOOTSTRAP_SERVERS=kafka:9092" >> .env
            echo "UPLOAD_PATH=${{ secrets.UPLOAD_PATH }}" >> .env
            echo "DOWNLOAD_PATH=${{ secrets.DOWNLOAD_PATH }}" >> .env
            echo "WEBAUTHN_RP_ID=${{ secrets.WEBAUTHN_RP_ID }}" >> .env
            echo "WEBAUTHN_ORIGIN=${{ secrets.WEBAUTHN_ORIGIN }}" >> .env
            echo "KMS_URL=ws://kms:8888/kurento" >> .env
            echo "COMPOSE_PROJECT_NAME=showping" >> .env
            
            # 1. 강력한 청소 (핵심 조치)
            # 모든 컨테이너 강제 중지 및 삭제 (이름 충돌 방지)
            docker rm -f $(docker ps -aq) || true 
            # 사용하지 않는 모든 도커 리소스 삭제 (용량 확보)
            docker system prune -af --volumes || true 
            
            # 2. 포트 강제 종료 (SIGKILL)
            sudo fuser -k -9 -n tcp 8888 || true
            sudo fuser -k -9 -n tcp 8080 || true
            sudo fuser -k -9 -n tcp 27017 || true
            sleep 5
            
            # 3. 배포 실행
            docker-compose pull
            docker-compose up -d